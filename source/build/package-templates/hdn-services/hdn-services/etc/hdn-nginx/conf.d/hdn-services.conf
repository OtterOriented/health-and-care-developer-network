#ssl_certificate "/etc/hdn-services/certificate-and-bundle.pem";
#ssl_certificate_key "/etc/hdn-services/privatekey.pem";

# http://serverfault.com/questions/381545/how-to-extract-only-the-file-name-from-the-request-uri
# Gets the basename of the original request
map $request_uri $request_basename
{
	~/(?<captured_request_basename>[^/?]*)(?:\?|$) $captured_request_basename;
}

upstream gs1
{
	server 127.0.0.1:7000;
}

upstream jetty
{
	server 127.0.0.1:8080;
}

upstream fourstore
{
	server 127.0.0.1:9000;
}

server
{
	listen [::]:80 default_server backlog=1024 deferred so_keepalive=off;
	#listen [::]:443 default_server backlog=1024 deferred so_keepalive=off ssl;
	
	#server_name $hostname.cloudapp.net;
	server_name *.cloudapp.net;
	server_name_in_redirect on;
	
	rewrite_log on;
	
	# Files without extensions are html - means try_files has less work to do
	default_type text/html;
	
	more_set_headers "Server: HDN";
	more_set_headers -s 405 "Allow: GET, HEAD";
	
	set $host_bad Y;
	# Reject weirdness, eg GET proxypass.com and so on
	#if ($host = "$hostname.cloudapp.net")
	#{
	#	set $host_bad N;
	#}
	#if ($host_bad = "Y")
	#{
	#	return 403;
	#}
	
	root /srv/hdn-nginx/hdn-services/content;
	
	# Do not allow direct linking to static gz files
	location ~ \.(?:gz)$
	{
		internal;
	}
	
	# Drop invalid locations
	location ~ \.(?:aspx|php|jsp|asp|cgi|shtml|htm)$
	{
		return 410;
	}
	
	# Hosted WAR
	location /itk-samples/
	{
		# ?: is a 'non-capturing mark'
		if ($request_method !~ ^(?:GET|HEAD|POST)$)
		{
			return 405;
		}

		proxy_pass http://jetty/itk-samples/;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
		proxy_redirect off;
		proxy_buffering off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	
	location /itk/
	{
		# HTML files
		location ~ \.(?:html)$
		{
			if ($request_method !~ ^(?:GET|HEAD)$)
			{
				return 405;
			}

			add_header Strict-Transport-Security "max-age=3600";

			expires 60m;

			# Click Jacking protection (disallows use of IFRAME)
			add_header X-Frame-Options DENY;

			# IE XSS protection for HTML
			add_header X-XSS-Protection "1; mode=block";

			add_header X-DNS-Prefetch-Control on;

			add_header X-UA-Compatible "IE=edge,chrome=1";
			add_header X-RIM-Auto-Match "none";

			add_header Access-Control-Allow-Origin "*";
			
			# Content-Language
			add_header Content-Language "en";
		}

		# CSS
		location ~ \.(?:css)$
		{
			if ($request_method !~ ^(?:GET|HEAD)$)
			{
				return 405;
			}

			add_header Strict-Transport-Security "max-age=8640000";

			# See https://developers.google.com/webmasters/control-crawl-index/docs/robots_meta_tag
			add_header X-Robots-Tag none;

			# expires max does not set cache-control to public
			add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
			add_header Cache-Control "public, max-age=315360000";

			# Prevent IE trying to deduce MIME type rather than use Content-Type header for CSS and Javascript
			add_header X-Content-Type-Options nosniff;
		}

		# Images
		location ~ \.(?:gif|png|jpg|ico|bmp|svg)$
		{
			# ?: is a 'non-capturing mark'
			if ($request_method !~ ^(?:GET|HEAD)$)
			{
				return 405;
			}

			add_header Strict-Transport-Security "max-age=8640000";

			add_header X-Robots-Tag none;
			add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
			add_header Cache-Control "public, max-age=315360000";
		}

		# Javascript
		location ~ \.(?:js)$
		{
			# ?: is a 'non-capturing mark'
			if ($request_method !~ ^(?:GET|HEAD)$)
			{
				return 405;
			}

			add_header Strict-Transport-Security "max-age=8640000";

			add_header X-Robots-Tag none;
			add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
			add_header Cache-Control "public, max-age=315360000";

			# Prevent IE trying to deduce MIME type rather than use Content-Type header
			add_header X-Content-Type-Options nosniff;
		}

		# Can not support svg fonts, as no way to distinguish from svg images. These regex location matches are used because of the shaggy javadoc output used by itk amongst others, which scatters resources throughout the folder hierarchy
		# Fonts
		location ~ \.(?:eot|ttf|woff)$
		{
			# ?: is a 'non-capturing mark'
			if ($request_method !~ ^(?:GET|HEAD)$)
			{
				return 405;
			}

			add_header Strict-Transport-Security "max-age=8640000";

			# See https://developers.google.com/webmasters/control-crawl-index/docs/robots_meta_tag
			add_header X-Robots-Tag none;

			# expires max does not set cache-control to public
			add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
			add_header Cache-Control "public, max-age=315360000";

			add_header Access-Control-Allow-Origin "*";

			add_header Content-Disposition "attachment; filename=$request_basename";
		}

		# PDF, JAR, WAR, EAR
		location ~ \.(?:pdf|jar|war|ear)$
		{
			# ?: is a 'non-capturing mark'
			if ($request_method !~ ^(?:GET|HEAD)$)
			{
				return 405;
			}

			add_header Strict-Transport-Security "max-age=8640000";

			# See https://developers.google.com/webmasters/control-crawl-index/docs/robots_meta_tag
			add_header X-Robots-Tag none;

			# expires max does not set cache-control to public
			add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
			add_header Cache-Control "public, max-age=315360000";

			add_header Content-Disposition "attachment; filename=$request_basename";
		}
		
		# ?: is a 'non-capturing mark'
		if ($request_method !~ ^(?:GET|HEAD)$)
		{
			return 405;
		}
		
		# $uri/staging/ is to try to force a redirect for the fact that there is not /itk/index.html...
		try_files $uri $uri/ $uri/staging/ =404;
		
		index index.html;
		
		add_header Strict-Transport-Security "max-age=3600";
		
		expires 60m;
		
		# Click Jacking protection (disallows use of IFRAME)
		add_header X-Frame-Options DENY;
	
		# IE XSS protection for HTML
		add_header X-XSS-Protection "1; mode=block";
		
		add_header X-DNS-Prefetch-Control on;
		
		add_header X-UA-Compatible "IE=edge,chrome=1";
		add_header X-RIM-Auto-Match "none";
		
		add_header Access-Control-Allow-Origin "*";
	}
	
	location /gs1/
	{
		# ?: is a 'non-capturing mark'
		if ($request_method !~ ^(?:GET|HEAD)$)
		{
			return 405;
		}

		proxy_pass http://gs1/gs1/;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
		proxy_redirect off;
		proxy_buffering off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	
	location /elda/
	{
		# ?: is a 'non-capturing mark'
		if ($request_method !~ ^(?:GET|HEAD)$)
		{
			return 405;
		}

		proxy_pass http://jetty/elda/;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
		proxy_redirect off;
		proxy_buffering off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	
	location /sparql/
	{
		# ?: is a 'non-capturing mark'
		if ($request_method !~ ^(?:GET|HEAD)$)
		{
			return 405;
		}

		proxy_pass http://fourstore/sparql/;
		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
		proxy_redirect off;
		proxy_buffering off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	}
	
	location /errors/
	{
		# Note: can't add headers for 400 or 500 errors
		
		root /srv/hdn-nginx/hdn-services;
		internal;
	}
}

server
{
	listen [::ffff:127.0.0.1]:80;
	listen [::1]:80;
	server_name localhost ip6-localhost ip6-loopback;
	
	# ?: is a 'non-capturing mark'
	if ($request_method !~ ^(?:GET|HEAD)$)
	{
		return 405;
	}
	
	add_header Strict-Transport-Security "max-age=8640000";
	add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
	add_header Cache-Control "public, max-age=315360000";
	
	return 301 http://$hostname.cloudapp.net$request_uri;
}

#server
#{
#	listen [::ffff:127.0.0.1]:443 ssl;
#	listen [::1]:443 ssl;
#	server_name localhost ip6-localhost ip6-loopback;
#	
#	# ?: is a 'non-capturing mark'
#	if ($request_method !~ ^(?:GET|HEAD)$)
#	{
#		return 405;
#	}
#	
#	add_header Strict-Transport-Security "max-age=8640000";
#	add_header Expires "Thu, 31 Dec 2037 23:55:55 GMT";
#	add_header Cache-Control "public, max-age=315360000";
#	
#	return 301 https://$hostname.cloudapp.net$request_uri;
#}
